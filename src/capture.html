<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="style.css" />
        <script defer="defer" src="https://eu.sokool.io/bundle.js"></script>
	<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    </head>
    <body style="background-color: #dce1e3">
        <div id="canvas-wrapper" style="position: relative">
            <canvas id="canvas" width="640" height="360"></canvas>
        </div>
        <video id="vidout" autoplay style="width:320px; height:180px; background-color: yellow;"></video>
        <video id="local-player" autoplay style="width:320px; height:180px; background-color: red;"></video>

	<button onclick="capture()">capture</button>
	<button onclick="agora()">agora</button>
    </body>

    <script>
        window.addEventListener('load', function () {
            AvatarUtils.createAvatar();
        })

	function capture() {
		 var stream = document.getElementById("canvas").captureStream(30);
		 var video = document.getElementById("vidout");
		video.srcObject = stream;
		video.play();
	}

        var appid="20b7c51ff4c644ab80cf5a4e646b0537";
        var room="avatar";
        var agoraClient=AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

        async function agora() {
           await agoraClient.join(appid, room, null, null);
           var audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
	   var stream = document.getElementById("vidout").captureStream();

	   const videoTracks = stream.getVideoTracks();
	   const videoStream = new MediaStream();
	   videoTracks.forEach(track => videoStream.addTrack(track));

	   var vl=videoStream.getVideoTracks().length;
	   var videoTrack = await AgoraRTC.createCustomVideoTrack({ mediaStreamTrack: videoStream.getVideoTracks()[0] })
           await agoraClient.publish([audioTrack,videoTrack]);
    	   videoTrack.play("local-player");
        }
    </script>
</html>
